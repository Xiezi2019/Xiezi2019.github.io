new一个对象的过程

一、对象的创建

1.虚拟机遇到一个new指令，检查指令参数是否能在常量池中定位到一个类的符号应用，如果没有，类未定义，抛出异常ClassNotFoundException;

2.进而检查这个符号引用所代表的类是否已被加载、解析和初始化。如果没有，必须向执行相应的类加载过程：找到该类的class文件，加载进方法区；已被加载，分配内存；

-- 分配内存的方式

- 指针碰撞：堆内存绝对规整，类似于称的左右标尺，指针作为分界点指示器；

-  空闲链表：堆内存已使用内存和空间的内存交错，虚拟机维护一个空闲链表，记录可用和不可用；

-- 内存分配的并发问题

- 同步的办法：CAS + 失败重试 保证更新操作的原子性
- 内存分配的动作安线程划分在不同空间进行：TLAB(每个线程在队中预先分配一小块内存，本地线程分配缓冲)          -XX:+/-UseTLAB   

二、设置对象头

 --对象的内存布局

- 对象头：存储运行时数据：哈希码、GC分代年龄、锁的状态、线程持有的锁、偏向线程的ID；     类型指针：对象指向他的类元数据的指针，通过该指针确定对象属于哪个类；

- 实例数据：对象真正存储的有效信息 程序代码中定义的各种类型的字段内容

- 对齐填充：占位符的作用， 因为虚拟机要求对象起始地址必须是8字节的整数倍。填充数据不是必须存在的，仅仅是为了字节对齐。 

  至此，对象创建完成。初始化零值。

三、对象初始化

  执行init方法，根据程序中代码分配初始值。

先初始化父类的静态代码--->初始化子类的静态代码-->初始化父类的非静态代码--->初始化父类构造函数--->初始化子类非静态代码--->初始化子类构造函数

四、对象定位访问

  将内存地址赋给栈内存中的引用变量：

  对象实例数据存放在堆中，类型数据存放在方法区中；

   直接指针(常用)： 栈（本地变量表）中的reference中存的是对象地址，速度快，节省了一次指针定位的开销。

![1593224737559](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1593224737559.png)

  句柄访问：堆内划分一块内存作为句柄池，局部变量表中reference中存的是句柄的地址，对象移动（垃圾收集）时 只需改变句柄中实例数据的指针，不需要修改【ref】。

![1593224718798](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1593224718798.png)

